<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style tyle="text/css">
        body {
            margin: 0;  
            max-height: 100vh;
            height: 100vh;

            height: 100%;
            background: #343a3f;
            color: #FFF;
            font-family: Helvetica;
            text-align: center;

            display: grid;
            grid-template-rows: 1fr 5fr;
            grid-template-columns: 1fr 5fr;
            grid-template-areas: 
                "header header"
                "nav main";
            grid-gap: .25em;        
        }
        header {
            grid-area: header;
        }
        nav {
            grid-area: nav;
            overflow: auto;
        }
        main {
            grid-area: main;
            overflow: hidden;
        }
        header, nav, main {
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 3px;
        }

        .navigate a {
            background-color: #4CAF50;
            color: white;

            text-decoration: none;
            display: inline-block;
            padding: 8px 16px;
            margin: 3px;
        }
        .navigate a:hover {
            background-color: #ddd;
            color: black;
        }              

        .layers ul { 
            padding: 0 0 0 0;
            list-style: none;
            text-align: left;
        }
        .layers li { 
            padding: 2px 0 2px 32px;
        }
    </style>
</head>

<script src="jscript/svg-pan-zoom/svg-pan-zoom.min.js" type="text/javascript"></script>

<body>
    <header>
        <h1>Image {{ image_id }} / {{ image_count }} </h1>
        <div class="navigate">
            <a href="d2.html?id=1">First</a>
            <a href="d2.html?id={{ prev_prev_image_id }}">&laquo; &laquo; Previous</a>
            <a href="d2.html?id={{ prev_image_id }}">&laquo; Previous</a>
            <a href="d2.html?id={{ image_id }}">Refresh</a>
            <a href="d2.html?id={{ next_image_id }}">Next &raquo;</a>
            <a href="d2.html?id={{ next_next_image_id }}">Next &raquo; &raquo;</a>
            <a href="d2.html?id={{ last_image_id }}">Last</a>
        </div>
    </header>
    <nav>
        <div id="layers" class="layers" />
    </nav>
    <main>
        <div id="svgContainer" style="height: 100%;">{{ svg | safe }}</div>
    </main>

    <script type="text/javascript">
        function createLayerItem(layerContent, node, name, id) {
            var checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.checked = true;
            checkbox.onchange = function (event) {
                let visible = event.target.checked;
                node.setAttribute("visibility", visible ? "visible" : "hidden");
            };

            var label = document.createElement('label')
            label.id = id;
            label.appendChild(document.createTextNode(name));

            var li = document.createElement('li')
            li.appendChild(checkbox);
            li.appendChild(label);

            layerContent.appendChild(li);
            return li;
        }

        var svg = null;
        var preserveSize = []

        // find svg
        let svgContent = document.getElementById("svgContainer").childNodes;
        for (let i = 0; i < svgContent.length; i++) {
            if (svgContent[i].nodeName == "svg") {
                svg = svgContent[i];
                break;
            }
        }
        svg.setAttribute("style", "display: inline; min-width: 100%; min-height: 100%; max-width: 100%; max-height: 100%")

        let layerContent = document.getElementById("layers");

        //parse svg
        let openNodes = [[svg, layerContent]];
        let auto_id = 0;
        while (openNodes.length > 0) {
            let current = openNodes.pop();
            let children = current[0].children;
            let docParent = current[1];
            let listParent = undefined;
            for (let i = 0; i < children.length; i++) {
                let node = children[i];
                if (node.tagName == "g") {
                    let name = node.id;
                    let id = "layer_" + auto_id;
                    auto_id += 1;
                    if (!name) { name = id; }

                    // groups to preserve size
                    if (node.getAttribute("preserve-size")) {
                        preserveSize.push(node);
                    }

                    //layers
                    if (!listParent) {
                        listParent = docParent.appendChild(document.createElement('ul'));
                    }
                    let childNode = createLayerItem(listParent, node, name, id);

                    openNodes.push([node, childNode]);
                }
            }
        }

        var panZoom = svgPanZoom('svg', {
            zoomEnabled: true,
            controlIconsEnabled: true,
            fit: true,
            center: true,
            zoomScaleSensitivity: 0.5,
            onZoom: function (v) {
                let scl = 1 / v;
                preserveSize.forEach(node => {
                    let trsf = node.getAttribute("transform").replace(/scale\(([^)]+)\)/i, "scale(" + scl + ")");
                    node.setAttribute("transform", trsf);
                })
            }
        });

        window.onresize = function () {
            panZoom.resize();
            panZoom.fit();
            panZoom.center();
        };
    </script>

</body>

</html>