<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style style="text/css">
        body {
            margin: 0;  
            max-height: 100vh;
            height: 100vh;

            height: 100%;
            background: #343a3f;
            color: #FFF;
            font-family: Helvetica;
            text-align: center;

            display: grid;
            grid-template-rows: 1fr 5fr;
            grid-template-columns: 1fr 5fr;
            grid-template-areas: 
                "header header"
                "nav main";
            grid-gap: .25em;        
        }
        header {
            grid-area: header;
        }
        nav {
            grid-area: nav;
            overflow: auto;
        }
        main {
            grid-area: main;
            overflow: hidden;
        }
        header, nav, main {
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 3px;
        }

        .controls button {
            background-color: #4CAF50;
            color: white;
            border: 0;
            font-family: Helvetica;
            text-decoration: none;
            display: inline-block;
            padding: 8px 16px;
            margin: 3px;
        }
        .controls button:hover {
            background-color: #ddd;
            color: black;
        }  

        .navigate a {
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            display: inline-block;
            padding: 8px 16px;
            margin: 3px;
        }        
        .navigate a:hover {
            background-color: #ddd;
            color: black;
        }              

        .groups ul { 
            padding: 0 0 0 0;
            list-style: none;
            text-align: left;
        }
        .groups li { 
            padding: 2px 0 2px 32px;
        }
    </style>
</head>

<script src="jscript/three/three.min.js" type="text/javascript"></script>
<script src="jscript/three/OrbitControls.js" type="text/javascript"></script>
<script src="jscript/three/GLTFLoader.js" type="text/javascript"></script>

<script type="text/javascript">
    var models = {{ model_list | safe }};
    var model_id = 0;

    var container;
    var renderer, scene, lights;
    var camera, orbitControls;
    var sceneCenter, sceneRadius;

    function init() {
        container = document.getElementById('modelContainer');

        // LOADER
        loader = new THREE.GLTFLoader();
        //THREE.DRACOLoader.setDecoderPath('js/libs/draco/gltf/');
        //loader.setDRACOLoader(new THREE.DRACOLoader());

        // RENDERER
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.gammaOutput = true;
        renderer.physicallyCorrectLights = true;
        //renderer.shadowMap.enabled = true;
        //renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // CAMERA
        camera = new THREE.PerspectiveCamera(45, container.offsetWidth / container.offsetHeight, 0.001, 1000);
        camera.position.y = 10;
        orbitControls = new THREE.OrbitControls(camera, renderer.domElement);

        // LIGHTS
        lights = {}
        // ambient        
        lights.ambient = new THREE.AmbientLight(0x222222);
        //directional
        lights.directional = new THREE.DirectionalLight(0xdddddd, 4);
        lights.directional.position.set(0, 0, 1).normalize();
        //spot            
        lights.spot = new THREE.SpotLight(0xffffff, 1);
        lights.spot.position.set(5, 10, 5);
        lights.spot.angle = 0.50;
        lights.spot.penumbra = 0.75;
        lights.spot.intensity = 100;
        lights.spot.decay = 2;
        lights.spot.castShadow = true;
        lights.spot.shadow.bias = 0.0001;
        lights.spot.shadow.mapSize.width = 2048;
        lights.spot.shadow.mapSize.height = 2048;
    }

    function releaseModel() {
    }

    function createModel() {
        releaseModel();

        let titleContent = document.getElementById('title');

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        scene.add(camera);
        scene.add(lights.ambient);
        scene.add(lights.directional);
        scene.add(lights.spot);

        //console.log("selecting data: ", model_id)
        if (model_id < 0 || model_id >= models.length) {
            // no model
            //console.log("empty data");
            titleContent.innerHTML = "Model - None" + "/" + (models.length).toString()
            return;
        }

        titleContent.innerHTML = "Model - " + (model_id + 1).toString() + "/" + (models.length).toString()

        loader.parse(models[model_id], "",
            function (data) {
                gltf = data;
                var object = gltf.scene;
                var center = new THREE.Vector3();
                var nCenter = 0;
                object.traverse(function (node) {
                    if (node.isMesh || node.isLight) node.castShadow = true;
                    if (node.geometry) {
                        node.geometry.computeBoundingBox();
                        center.add(node.geometry.boundingBox.center);
                        nCenter += 1;
                    }
                });

                center.divideScalar(nCenter);
                object.position.set(-center.x, -center.y, -center.z);

                scene.add(object);
                onWindowResize();
            }, undefined, function (error) {
                console.error(error);
            });
    }

    function selectModel(id) {
        model_id = id
        if (model_id < 0) model_id = 0;
        if (model_id >= models.length) model_id = models.length - 1;

        releaseModel();
        createModel();
    }

    function step(delta) {
        console.log(delta)
        selectModel(model_id + delta, true, true)
    }

    function onWindowResize() {
        camera.aspect = container.offsetWidth / container.offsetHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function render() {
        renderer.render(scene, camera);
    }

    function animate() {
        requestAnimationFrame(animate);
        orbitControls.update();
        render();
    }

    window.onload = function () {
        init();
        selectModel(0)
        animate();
    }
    window.onresize = function () {
        onWindowResize()
    }
</script>

<body>
    <header>
        <h1 id="title">Model</h1>
        <div class="controls">
            <button onclick="step(Number.MIN_SAFE_INTEGER)">First</button>
            <button onclick="step(-10)">&laquo; &laquo; Previous</button>
            <button onclick="step(-1)">&laquo; Previous</button>
            <button onclick="step(1)">Next &raquo;</button>
            <button onclick="step(10)">Next &raquo; &raquo;</button>
            <button onclick="step(Number.MAX_SAFE_INTEGER)">Last</button>
        </div>
        <div class="controls">
            {% include "controls.html" %}
        </div>
    </header>
    <nav>
        <div id="groups" class="groups" />
    </nav>
    <main>
        <div id="modelContainer" style="height: 100%;" />
    </main>
</body>

</html>